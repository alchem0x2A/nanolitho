<!doctype html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
  </head>

  <body class="container">
    <h1 class="text-center my-3">MBHL Simulator v0.1</h1>
    <p id="status">Loading...</p>
    <!-- Add your input boxes here -->
    <br />
    <div class="controls form-group mb-1">
    <label for="radius">Radius:</label>
    <input class="form-control-sm" id="radius" type="text" value="1" />
    <label for="thickness">Thickness:</label>
    <input class="form-control-sm" id="thickness" type="text" value="1" />
    <label for="angle">Angle:</label>
    <input class="form-control-sm" id="angle" type="text" value="1" />
    <label for="shift">Shift:</label>
    <input class="form-control-sm" id="shift" type="text" value="1" />
    <button id="run-button" onclick="evaluatePython()" disabled class="btn btn-primary mt-3">Run Python</button>
    <br />
    </div>

    <div class="row">
      <div class="col-lg-6">
        <div id="mplContainer1" class="border"></div>
      </div>
      <div class="col-lg-6">
        <div id="mplContainer2" class="border"></div>
      </div>
    </div>
    <!-- <canvas id="canvas"></canvas> -->

    <style>
      @keyframes blink {
        0% {opacity: 1;}
        50% {opacity: 0.4;}
        100% {opacity: 1;}
      }

      .blink {
        animation: blink 1s linear infinite;
      }
    </style>

    <script>
      // const canvas = document.getElementById("canvas");
      // const ctx = canvas.getContext('2d');
      const img = new Image();
      const status = document.getElementById('status');
      const runButton = document.getElementById('run-button');
      const mplContainer1 = document.getElementById("mplContainer1");
      const mplContainer2 = document.getElementById("mplContainer2");

      // Input values
      const radius = document.getElementById('radius').value;
      const thickness = document.getElementById('thickness').value;
      const angle = document.getElementById('angle').value;
      const shift = document.getElementById('shift').value;
      
      // img.onload = function() {
          // ctx.drawImage(img, 0, 0);
      // }
      status.classList.add('blink');

      // init Pyodide
      async function main() {
          let pyodide = await loadPyodide();
	  status.textContent = "Pyodide is ready, loading packages matplotlib, numpy and shapely...";
          console.log("Pyodide is ready");
          await pyodide.loadPackage(['numpy', 'matplotlib', 'shapely']);
	  status.textContent = "Pyodide modules loaded. Change your settings to run the simulation!";
	  status.classList.remove('blink');
          console.log("'numpy' and 'matplotlib' are loaded");
	  runButton.disabled = false;
        return pyodide;
      }
      let pyodideReadyPromise = main();

      async function evaluatePython() {
	  // status.textContent = "Running Python code...";
          // status.classList.add('blink');
	  // runButton.disabled = true;
	  // await new Promise(r => setTimeout(r, 0));
          let pyodide = await pyodideReadyPromise;
        try {
          let code = `
            import matplotlib.pyplot as plt
            import matplotlib
            import io
            import base64
            #matplotlib.use("module://matplotlib_pyodide.html5_canvas_backend")
            import numpy as np

            plt.cla()
            plt.close('all')
            fig, ax = plt.subplots()
            
            t = np.random.random(size=(150, 1))
            s = 1 + np.sin(2 * np.pi * t)

            ax.plot(t, s, "o")
            ax.set(xlabel='time (s)', ylabel='voltage (mV)', title='About as simple as it gets, folks')
            ax.grid()

            svg_io = io.BytesIO()
            plt.savefig(svg_io, format='svg')
            svg_str = base64.b64encode(svg_io.getvalue()).decode('utf-8')
          `;
            pyodide.runPython(code);
	    let svg_str = pyodide.globals.get("svg_str");
	    mplContainer1.innerHTML = '<img src="data:image/svg+xml;base64,' + svg_str + '">';
	    mplContainer2.innerHTML = '<img src="data:image/svg+xml;base64,' + svg_str + '">';
	    // status.textContent = "";
	    // runButton.disabled = false;
            // status.classList.remove('blink');
          // let imageData = await pyodide.globals.get("open")('/tmp/figure.png', 'rb').read();
          // img.src = 'data:image/png;base64,' + btoa(new TextDecoder("latin1").decode(imageData));
        } catch (err) {
	    // status.textContent = err;
            // status.classList.remove('blink');
	    // runButton.disabled = false;
          console.error(err);
        }
      }
      
    </script>
  </body>
</html>
